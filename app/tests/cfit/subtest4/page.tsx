'use client';
import Link from 'next/link';
import { ArrowLeft, Brain, Clock, ListChecks } from 'lucide-react';
import { motion } from 'framer-motion';
import { useState } from 'react';
import { div } from 'framer-motion/client';
import { useRouter } from 'next/navigation';

interface Question {
  id: number;
  images: string[];
  correctAnswer: number;
  explanationRight: string,
  explanationFalse: string
}

export default function CFITSubtest4() {
    const router = useRouter()
    const [resultText, setResultText] = useState<string>('')
    const [answers, setAnswers] = useState<number[]>([])
    const [currentQuestion, setCurrentQuestion] = useState(0)
    const [isChecked, setIsChecked] = useState<boolean | null>(false)

    // Data dummy
  const questions: Question[] = [
    {
        id: 1,
        images: ['q1-1.png'],
        correctAnswer: 3,
        explanationRight: 'Benar karena opsi yang dipilih benar',
        explanationFalse: 'Salah karena opsi yang dipilih tidak tepat'
      },
      {
        id: 2,
        images: ['q1-1.png'],
        correctAnswer: 5,
        explanationRight: 'Benar karena opsi yang dipilih benar',
        explanationFalse: 'Salah karena opsi yang dipilih tidak tepat'
      },
      {
        id: 3,
        images: ['q1-1.png'],
        correctAnswer: 2,
        explanationRight: 'Benar karena opsi yang dipilih benar',
        explanationFalse: 'Salah karena opsi yang dipilih tidak tepat'
      }
  ];

  const handleAnswer = (answerIndex: number) =>{
      if (isChecked === true)
        return
      console.log(answers)
  
      const newAnswers = [...answers];
      newAnswers[currentQuestion] = answerIndex;
      setAnswers(newAnswers);
  
      console.log(answers)
   }

   const checkAnswer = (questionIndex: number) => {
      const answer = answers[questionIndex]
  
      if(answer !== undefined) {
        setIsChecked(true)
      }
  
      if (answer === questions[questionIndex].correctAnswer) {
        setResultText(questions[questionIndex].explanationRight)
    } else {
        setResultText(questions[questionIndex].explanationFalse)
    }
   }

    const handleTestComplete = () => {
        const testSession = sessionStorage.getItem('testSession')
        if(!testSession)
            return alert('gagal')

        const testSessionParsed = JSON.parse(testSession)
        const tests = testSessionParsed.tests[testSessionParsed.currentIndex]
        if(tests) {
            router.push(`/tests/${tests.toLowerCase()}`)
            const indexIncrement = testSessionParsed.currentIndex + 1
            testSessionParsed.currentIndex = indexIncrement

            const updatedTestString = JSON.stringify(testSessionParsed)
            sessionStorage.setItem('testSession', updatedTestString)        
        } else {
            sessionStorage.clear()
            router.push('/result')
        }
        // router.push('/tests/cfit/subtest4/test')
    }
  
    const resetState = () => {
      setResultText('')
      setIsChecked(false)
      setAnswers([])
    }

    const handleNext = () => {
      resetState()
      setCurrentQuestion(prev => prev + 1)
    }

    return(
        <div className='font-sans min-h-screen bg-gradient-to-br from-red-50 to-indigo-100 flex flex-col'>
            {/* header */}
            <header className="bg-white shadow-sm py-4 sticky top-0 z-10">
                <div className="container mx-auto px-6 flex justify-between items-center">
                    <div className="flex items-center gap-2">
                        <Brain className="text-blue-600" size={28} />
                        <h1 className="text-xl font-bold text-gray-800">CFIT - Subtes 4</h1>
                    </div>
                </div>
            </header>

            {/* Main Content */}
            <main className="flex-grow container mx-auto px-4 py-10">
                <motion.div
                initial={{ opacity: 0, y: 20 }}
                animate={{ opacity: 1, y: 0 }}
                transition={{ duration: 0.5 }}
                className="max-w-5xl mx-auto bg-white rounded-2xl shadow-lg p-8"
                >
                {/* Section: Petunjuk */}
                <section className="mb-10">
                    <h2 className="text-2xl font-semibold text-gray-800 mb-6 flex items-center gap-2">
                    <ListChecks className="text-blue-600" size={22} />
                    Petunjuk Subtes 4
                    </h2>

                    <div className="bg-blue-50 border border-blue-200 rounded-xl p-6">
                    <p className="text-gray-700 mb-4">
                        Pada subtes ini, Anda akan dihadapkan dengan rangkaian gambar yang membentuk suatu pola.
                        Tugas Anda adalah:
                    </p>
                    <ul className="list-disc list-inside space-y-2 text-gray-700">
                        <li>Mengamati rangkaian gambar yang disajikan</li>
                        <li>Menemukan pola atau hubungan antara gambar-gambar tersebut</li>
                        <li>Memilih gambar yang tepat untuk melengkapi rangkaian tersebut</li>
                        <li>
                        <Clock className="inline-block text-blue-500 mr-1" size={16} />
                        Waktu pengerjaan: <span className="font-semibold">3 menit</span>
                        </li>
                        <li>Jumlah soal: <span className="font-semibold">13 butir</span></li>
                    </ul>
                    </div>
                </section>

                {/* Section: Contoh Soal */}
                <section className="mb-10">
                    <h2 className="text-2xl font-semibold text-gray-800 mb-6">Contoh Soal</h2>
                    <div className="border border-gray-200 rounded-xl p-6 bg-gray-50">
                    <p className="text-sm text-gray-600 mb-4">
                        Perhatikan rangkaian gambar berikut dan tentukan gambar yang tepat untuk mengisi kotak terakhir:
                    </p>
                    {/* (perubahan) penambahan contoh soal @rezky */}
                    <div className="flex justify-center items-center bg-white rounded-lg p-8 border">
                        <div className='w-full flex flex-col gap-3 text-gray-400 italic'>
                        <div>
                            <p>Jawab soal berikut dengan teliti dan cepat.</p>
                        </div>
                        <div className="w-1/3 grid grid-cols-1 md:grid-cols-1 gap-4 mb-6 text-gray-400 italic m-auto">
                            {questions[currentQuestion].images.map((img, i) => (
                            <div
                                key={i}
                                className="aspect-square bg-slate-100 rounded-xl flex items-center justify-center text-slate-400 border border-slate-200"
                            >
                                <span className="text-xs font-medium">Gambar {i + 1}</span>
                            </div>
                            ))}
                        </div>
                            <div className="text-center text-slate-700 mb-6">
                            Pilih gambar yang paling tepat untuk melengkapi pola:
                            </div>

                            <div className="grid grid-cols-2 sm:grid-cols-6 gap-4 w-full">
                            {[1, 2, 3, 4, 5, 6].map(option => (
                                <button
                                key={option}
                                onClick={() => handleAnswer(option)}
                                // className={`aspect-square text-lg font-semibold rounded-xl flex items-center justify-center transition-all border-2 ${
                                //   answers[currentQuestion] === option
                                //     ? 'bg-blue-600 text-white border-blue-600 scale-105 shadow'
                                //     : 'border-slate-200 bg-slate-50 hover:border-blue-400 hover:scale-[1.02]'
                                // }`}
                                    className={`aspect-square text-lg font-semibold rounded-xl flex items-center  justify-center transition-all border-2 ${
                                    // isChecked === true && option === questions[currentQuestion].correctAnswer
                                    // ? 'bg-green-600 text-white border-green-600 scale-105 shadow '
                                    // : answers[currentQuestion] === option
                                    // ? 'bg-blue-600 text-white border-blue-600 scale-105 shadow '
                                    // : 'border-slate-200 bg-slate-50 hover:border-blue-400 hover:scale-[1.02]'


                                    isChecked === true && option === questions[currentQuestion].correctAnswer
                                    ? 'bg-green-600  text-white border-green-600 scale-105 shadow'
                                    : isChecked === true && !(option === questions[currentQuestion].correctAnswer) && answers[currentQuestion] === option
                                    ? 'bg-red-600 text-white border-red-600 scale-105 shadow'
                                    : answers[currentQuestion] === option
                                    ? 'bg-blue-600 text-white border-blue-600 scale-105 shadow'
                                    : isChecked === false || answers[currentQuestion] === option
                                    ? ' hover:border-blue-400 hover:scale-[1.02] border-slate-200 bg-slate-50'
                                    : !(isChecked === true && option === questions[currentQuestion].correctAnswer)
                                    ? 'border-slate-200 bg-slate-50'
                                    : ''

                                    // answers[currentQuestion] === option
                                    // ? 'bg-blue-600 text-white border-blue-600 scale-105 shadow'
                                    // : 'hover:border-blue-400 hover:scale-[1.02] border-slate-200 bg-slate-50'

                                    }`}
                                    
                                >
                                {option}
                                </button>
                            ))}
                            </div>

                            <div className=''>
                            <button onClick={() => checkAnswer(currentQuestion)} disabled = {isChecked === true} className={` px-8 py-3 rounded-lg font-semibold  ${
                                isChecked === true
                                ? 'bg-blue-400 text-gray-200'
                                : 'bg-blue-600 hover:bg-blue-700 text-white'
                                }`} >Cek Jawaban</button>
                            </div>
                            <div>
                            <p>{resultText}</p>
                            </div>  

                            <div className="flex justify-between items-center">
                                <button
                                    onClick={() => 
                                    {
                                        setCurrentQuestion(prev => Math.max(0, prev - 1))
                                        resetState()
                                    }}
                                    disabled={currentQuestion === 0}
                                    className={`px-4 py-2 rounded-lg border text-sm font-medium transition ${
                                    currentQuestion === 0
                                        ? 'opacity-50 cursor-not-allowed bg-slate-50 text-slate-400 border-slate-200'
                                        : 'bg-white border-slate-300 hover:bg-slate-50 text-slate-700'
                                    }`}
                                >
                                    ← Sebelumnya
                                </button>

                                <button
                                    onClick={
                                    currentQuestion === questions.length - 1
                                        ? handleTestComplete
                                        : handleNext
                                    }
                                    className="px-5 py-2 rounded-lg bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-medium shadow hover:scale-[1.02] active:scale-95 transition"
                                >
                                    {currentQuestion === questions.length - 1 ? 'Selesai' : 'Soal Berikutnya →'}
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    </div>
                </section>

                {/* Section: Tombol Aksi */}
                <div className="text-center space-x-4">
                    <Link href="/tests/cfit/subtest4/test" className="inline-block">
                    <button className="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 shadow-md hover:shadow-lg transition-all">
                        Mulai Subtes 4
                    </button>
                    </Link>
                </div>
                </motion.div>
            </main>
        </div>
    )
}